<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Astriarch WebSocket Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .message-log { 
            border: 1px solid #ccc; 
            height: 300px; 
            overflow-y: auto; 
            padding: 10px; 
            margin: 10px 0; 
            background: #f9f9f9;
        }
        .controls { margin: 10px 0; }
        button { margin: 5px; padding: 10px; }
        input, select { margin: 5px; padding: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Astriarch WebSocket Test Client</h1>
        
        <div class="controls">
            <button onclick="connect()">Connect</button>
            <button onclick="disconnect()">Disconnect</button>
            <span id="status">Disconnected</span>
        </div>

        <div class="controls">
            <h3>Game Actions</h3>
            <button onclick="sendMessage('NOOP', {message: 'Hello', counter: 0})">Send NOOP</button>
            <button onclick="sendMessage('PING', {})">Send PING</button>
            <button onclick="sendMessage('LIST_GAMES', {})">List Games</button>
        </div>

        <div class="controls">
            <h3>Create/Join Game</h3>
            <input type="text" id="playerName" placeholder="Player Name" value="TestPlayer">
            <input type="text" id="gameName" placeholder="Game Name" value="Test Game">
            <button onclick="createGame()">Create Game</button>
            <br>
            <input type="text" id="gameIdToJoin" placeholder="Game ID to Join">
            <button onclick="joinGame()">Join Game</button>
        </div>

        <div class="message-log" id="messageLog"></div>

        <div class="controls">
            <h3>Raw Message</h3>
            <select id="messageType">
                <option value="NOOP">NOOP</option>
                <option value="PING">PING</option>
                <option value="LIST_GAMES">LIST_GAMES</option>
                <option value="CREATE_GAME">CREATE_GAME</option>
                <option value="JOIN_GAME">JOIN_GAME</option>
                <option value="START_GAME">START_GAME</option>
                <option value="END_TURN">END_TURN</option>
                <option value="SEND_SHIPS">SEND_SHIPS</option>
            </select>
            <input type="text" id="messagePayload" placeholder="JSON Payload" value="{}">
            <button onclick="sendRawMessage()">Send Raw</button>
        </div>
    </div>

    <script>
        let ws = null;
        let currentGameId = null;

        // Message type constants (matching backend)
        const MESSAGE_TYPE = {
            NOOP: 0,
            PING: 1,
            LIST_GAMES: 10,
            CREATE_GAME: 11,
            JOIN_GAME: 12,
            START_GAME: 13,
            RESUME_GAME: 14,
            CHANGE_GAME_OPTIONS: 15,
            CHANGE_PLAYER_NAME: 16,
            END_TURN: 20,
            SEND_SHIPS: 21,
            UPDATE_PLANET_START: 22,
            UPDATE_PLANET_OPTIONS: 23,
            UPDATE_PLANET_BUILD_QUEUE: 24,
            CLEAR_WAYPOINT: 25,
            ADJUST_RESEARCH_PERCENT: 26,
            SUBMIT_RESEARCH_ITEM: 27,
            CANCEL_RESEARCH_ITEM: 28,
            SUBMIT_TRADE: 29,
            CANCEL_TRADE: 30,
            CHAT_MESSAGE: 40,
            EXIT_RESIGN: 50,
            LOGOUT: 51,
            // Server responses
            PONG: 2,
            ERROR: 60,
            GAME_LIST_UPDATED: 61
        };

        function log(message) {
            const messageLog = document.getElementById('messageLog');
            const time = new Date().toLocaleTimeString();
            messageLog.innerHTML += `<div>[${time}] ${message}</div>`;
            messageLog.scrollTop = messageLog.scrollHeight;
        }

        function updateStatus(status) {
            document.getElementById('status').textContent = status;
        }

        function connect() {
            if (ws) {
                log('Already connected');
                return;
            }

            ws = new WebSocket('ws://localhost:8001');
            
            ws.onopen = function() {
                log('‚úÖ Connected to WebSocket server');
                updateStatus('Connected');
            };

            ws.onmessage = function(event) {
                try {
                    const message = JSON.parse(event.data);
                    log(`üì• Received: ${getMessageTypeName(message.type)} - ${JSON.stringify(message.payload)}`);
                    
                    // Handle specific message types
                    if (message.type === MESSAGE_TYPE.CREATE_GAME && message.payload) {
                        currentGameId = message.payload;
                        log(`üéÆ Game created with ID: ${currentGameId}`);
                        document.getElementById('gameIdToJoin').value = currentGameId;
                    }
                } catch (error) {
                    log(`‚ùå Error parsing message: ${event.data}`);
                }
            };

            ws.onclose = function() {
                log('‚ùå Disconnected from WebSocket server');
                updateStatus('Disconnected');
                ws = null;
            };

            ws.onerror = function(error) {
                log(`‚ùå WebSocket error: ${error}`);
            };
        }

        function disconnect() {
            if (ws) {
                ws.close();
            }
        }

        function sendMessage(type, payload) {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                log('‚ùå Not connected to server');
                return;
            }

            const message = {
                type: MESSAGE_TYPE[type],
                payload: payload
            };

            ws.send(JSON.stringify(message));
            log(`üì§ Sent: ${type} - ${JSON.stringify(payload)}`);
        }

        function createGame() {
            const playerName = document.getElementById('playerName').value || 'TestPlayer';
            const gameName = document.getElementById('gameName').value || 'Test Game';
            
            sendMessage('CREATE_GAME', {
                name: gameName,
                playerName: playerName
            });
        }

        function joinGame() {
            const playerName = document.getElementById('playerName').value || 'TestPlayer';
            const gameId = document.getElementById('gameIdToJoin').value;
            
            if (!gameId) {
                log('‚ùå Please enter a game ID to join');
                return;
            }

            sendMessage('JOIN_GAME', {
                gameId: gameId,
                playerName: playerName
            });
        }

        function sendRawMessage() {
            const messageType = document.getElementById('messageType').value;
            const payloadText = document.getElementById('messagePayload').value || '{}';
            
            try {
                const payload = JSON.parse(payloadText);
                sendMessage(messageType, payload);
            } catch (error) {
                log(`‚ùå Invalid JSON payload: ${error.message}`);
            }
        }

        function getMessageTypeName(typeNumber) {
            for (const [name, value] of Object.entries(MESSAGE_TYPE)) {
                if (value === typeNumber) {
                    return name;
                }
            }
            return `Unknown(${typeNumber})`;
        }

        // Auto-connect on page load
        window.onload = function() {
            log('üöÄ WebSocket test client loaded. Click Connect to start.');
        };
    </script>
</body>
</html>
